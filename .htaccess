# ============================================================
# üîí SECURITY CONFIGURATION - Delizio Sushi
# ============================================================

# ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Mod_rewrite
RewriteEngine On

# ----------------------------------------------------
# üõ°Ô∏è SECURITY PROTECTIONS
# ----------------------------------------------------

# Protect .env and config files
<FilesMatch "^\.env|^config\.php">
    Order allow,deny
    Deny from all
</FilesMatch>

# Protect .git directory
RedirectMatch 404 /\.git

# Block access to sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak|sql|conf)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Disable directory browsing
Options -Indexes

# Disable server signature
ServerSignature Off

# ----------------------------------------------------
# üö´ BLOCK COMMON HACKING ATTEMPTS
# ----------------------------------------------------

# Block SQL Injection attempts
RewriteCond %{QUERY_STRING} (union|select|insert|drop|update|delete|concat|declare|exec|script) [NC,OR]
RewriteCond %{QUERY_STRING} ([a-z0-9]{2000,}) [NC,OR]
RewriteCond %{QUERY_STRING} (javascript|alert|document\.cookie) [NC,OR]
RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (\\x00|\\x08|\\x09|\\x0a|\\x0b|\\x0c|\\x0d) [NC]
RewriteRule ^(.*)$ / [R=302,L]

# Block file injection attempts
RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=http:// [OR]
RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=(\.\.//?)+ [OR]
RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=/([a-z0-9_.]//?)+ [NC]
RewriteRule ^(.*)$ / [R=302,L]

# Block directory traversal
RewriteCond %{QUERY_STRING} (\.\./|\.\.) [NC,OR]
RewriteCond %{REQUEST_URI} (\.\./) [NC]
RewriteRule ^(.*)$ / [R=302,L]

# Block PHP code injection
RewriteCond %{QUERY_STRING} (<\?php|<%|%3C%3F) [NC,OR]
RewriteCond %{QUERY_STRING} (globals|encode|config|localhost|loopback) [NC,OR]
RewriteCond %{QUERY_STRING} (request|mosconfig) [NC]
RewriteRule ^(.*)$ / [R=302,L]

# Block common exploit strings
RewriteCond %{QUERY_STRING} (base64_encode|base64_decode) [NC,OR]
RewriteCond %{QUERY_STRING} (benchmark|sleep|load_file) [NC,OR]
RewriteCond %{QUERY_STRING} (null|nullptr|waitfor) [NC]
RewriteRule ^(.*)$ / [R=302,L]

# Block bad user agents (bots/scrapers)
RewriteCond %{HTTP_USER_AGENT} (libwww|wget|curl|nikto|scan|sqlmap|acunetix) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (HTTrack|clshttp|archiver|loader|email|harvest|extract) [NC]
RewriteRule ^(.*)$ / [R=302,L]

# Block access to wp-admin (common target even for non-WP sites)
RewriteCond %{REQUEST_URI} (wp-admin|wp-login|xmlrpc) [NC]
RewriteRule ^(.*)$ / [R=302,L]

# ----------------------------------------------------
# üìù CUSTOM ERROR HANDLING
# ----------------------------------------------------

# Redirect 404 errors to index page
ErrorDocument 404 //
ErrorDocument 403 //
ErrorDocument 500 //

# ----------------------------------------------------
# üîÑ URL REWRITING (Clean URLs)
# ----------------------------------------------------

# Redirect .php requests to the non-extension version
RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ /([^.]+)\.php\ HTTP/ [NC]
RewriteRule ^ %1 [R=301,L]

# Redirect .html requests to the non-extension version (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå .html)
# RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ /([^.]+)\.html\ HTTP/ [NC]
# RewriteRule ^ %1 [R=301,L]

# ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå .php ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå)
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^(.*)$ $1.php [L]

# Redirect invalid URLs to index (fallback for non-existent pages)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ / [L]

# ----------------------------------------------------
# üîê SECURITY HEADERS
# ----------------------------------------------------

<IfModule mod_headers.c>
    # Prevent clickjacking
    Header set X-Frame-Options "SAMEORIGIN"
    
    # XSS Protection
    Header set X-XSS-Protection "1; mode=block"
    
    # Prevent MIME sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Referrer Policy
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remove server information
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# ----------------------------------------------------
# ‚ö° PERFORMANCE OPTIMIZATION
# ----------------------------------------------------

# Enable GZIP Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
</IfModule>